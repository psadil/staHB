---
title: "Main"
author: "pss"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data_dir: data
  expt: CFSgonogo
  model: "brms"
  flag: "dev"
  n_groups: 6
  n_trials_per_cond: 500
  chains: 2
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, root.dir = devtools::package_file(), message = FALSE, warning = FALSE, fig.width = 7, fig.asp = 1, cache = FALSE, cache.path = paste0(file.path(devtools::package_file(), "output", "cache", params$model, params$flag, params$participant), .Platform$file.sep), fig.path = paste0(file.path(devtools::package_file(), "output", "figures", params$model, params$flag), .Platform$file.sep) )

library(tidyverse)
library(magrittr)
library(modelr)
library(brms)
options(mc.cores = params$chains)

cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

Conditions = c('Not Studied', "Word", 'CFS, Image', 'Binocular, Image')

colmap <- c('Not Studied'=cbPalette[7]
            ,'Word'=cbPalette[2]
            ,'CFS, Image'=cbPalette[3]
            ,'Binocular, Image'=cbPalette[4])

old_theme <- theme_set(theme_classic(base_size = 12)) +
  theme_update(
    axis.ticks = element_blank()
    , axis.line = element_line(size=1)
    , plot.margin=margin(rep(0,4))
  )

```


```{r create_data}
mu_x <- c(-2,-1,1,2)
mu_y <- c(-2,1,-1,2)
d_Nmon <- crossing(factorX = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              factorY = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              trial = 1:params$n_trials_per_cond) %>%
  mutate(x_y = map2(factorX, factorY, ~ cbind(mu_x[.x],mu_y[.y]) + mvtnorm::rmvnorm(1, mean = rep(0,2)))) %>%
  mutate(evidenceX = map_dbl(x_y, ~purrr::pluck(.x, 1)),
         evidenceY = map_dbl(x_y, ~purrr::pluck(.x, 2)),
         outX = if_else(evidenceX > 0, 1, 0),
         outY = if_else(evidenceY > 0, 1, 0)
         ) %>%
  select(-x_y) %>%
  filter(factorX == factorY) %>%
  mutate(Condition = factorX) %>%
  mutate(muX = mu_x[factorX], muY = mu_y[factorY])


d_mon <- crossing(factorX = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              factorY = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              trial = 1:params$n_trials_per_cond) %>%
  mutate(x_y = map2(factorX, factorY, ~ cbind(mu_x[.x],mu_x[.y]) + mvtnorm::rmvnorm(1, mean = rep(0,2)))) %>%
  mutate(evidenceX = map_dbl(x_y, ~purrr::pluck(.x, 1)),
         evidenceY = map_dbl(x_y, ~purrr::pluck(.x, 2)),
         outX = if_else(evidenceX > 0, 1, 0),
         outY = if_else(evidenceY > 0, 1, 0)
         ) %>%
  select(-x_y) %>%
  filter(factorX == factorY) %>%
  mutate(Condition = factorX)
  

```

```{r, plot_data}

d_Nmon %>%
  ggplot(aes(x = evidenceX, y = evidenceY, fill = Condition)) +
  stat_ellipse(type = "norm", geom = "polygon") +
  coord_cartesian()

d_mon %>%
  ggplot(aes(x = evidenceX, y = evidenceY, fill = Condition)) +
  stat_ellipse(type = "norm", geom = "polygon") +
  coord_cartesian()

```



```{r}

mon_form <- brms::bf(cbind(outX, outY) ~ mo(Condition), 
                     family = binomial(link = "probit"))

Nmon_form <- brms::bf(outX ~ mo(factorX) + s(muY, bs="bs", m=1, k=3)) +
  brms::bf(outY ~ mo(factorY)  + s(muX, bs="bs", m=1, k=3)) +
  binomial(link = "probit")

mon_to_Nmon <- brms::brm(mon_form,
                         data = d_Nmon,
                         chains = params$chains)

Nmon_to_Nmon <- brms::brm(Nmon_form,
                         data = d_Nmon,
                         chains = params$chains,
                         save_model = "tmp.stan")

mon_to_mon <- update(mon_to_mon, newdata = d_mon)
Nmon_to_mon <- update(Nmon_to_mon, newdata = d_mon)


```


```{r waic1}
brms::WAIC(Nmon_to_Nmon, mon_to_Nmon)
```


```{r, waic2}
brms::WAIC(nmon_to_mon, mon_to_mon)
```


