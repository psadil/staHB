---
title: 'Model Recovery: Bivariate Probit'
author: "pss"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data_dir: data
  expt: CFSgonogo
  model: "bivariate_probit_mixed_onec_mo_nonc"
  flag: "part-30_item-20_snr-0p5_rho-0-0p5-n0p9_rep-5"
  reps: 5
  n_condition: 4
  condition_rho: !r c(0, 0.5, -0.9) 
  n_subject: 30
  n_item: !r c(20)
  type_model: !r c("mon", "nmon")
  type_data: !r c("mon", "nmon")
  subject_scale: 0.5
  item_snr: !r c(2)
  subject_rho: 0
  item_rho: 0
  chains: 6
  iter: 500
  warmup: 1000
  compile: 0
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, root.dir = devtools::package_file(), message = FALSE, warning = FALSE, fig.width = 7, fig.asp = 1, cache = FALSE, cache.path = paste0(file.path(devtools::package_file(), "output", "cache", params$model, params$flag, params$participant), .Platform$file.sep), fig.path = paste0(file.path(devtools::package_file(), "output", "figures", params$model, params$flag), .Platform$file.sep) )

devtools::load_all()

dir.model <- file.path(dir.stan_samples, params$model)
if (!dir.exists(dir.model)){
  dir.create(dir.model)
}
dir.model_flag <- file.path(dir.model, params$flag)
if (!dir.exists(dir.model_flag)){
  dir.create(dir.model_flag)
}

options(mc.cores = params$chains)
rstan::rstan_options("auto_write" = TRUE)

if (params$compile){
  rstan::stan_model(file.path(devtools::package_file(), "stan", paste0(params$model, ".stan")))
}

d <- gen_grand_data_snr(params)
```


.
```{r, plot_data}

# d %>%
#   rename(Correlation = condition_rho) %>%
#   mutate(condition = factor(condition)) %>%
#   ggplot(aes(x = evidence_x, y = evidence_y, fill = condition)) +
#   stat_ellipse(type = "norm", geom = "polygon") +
#   coord_cartesian() +
#   coord_fixed() +
#   scale_y_continuous(name = "Evidence for Task 2") +
#   scale_x_continuous(name = "Evidence for Task 1") +
#   facet_wrap(~Correlation, labeller = "label_both") +
#   theme_classic() +
#   theme(legend.position = "bottom",
#         strip.background = element_blank()) 
# ggsave("nonmono_data.png", width = 6, height = 4)


d %>%
  rename(Correlation = condition_rho) %>%
  mutate(condition = factor(condition)) %>%
  ggplot(aes(x = evidence_x, y = evidence_y, fill = condition, color=condition)) +
  stat_ellipse(type = "norm", geom = "polygon") +
  # geom_point(alpha = 0.3) +
  coord_cartesian() +
  coord_fixed() +
  scale_y_continuous(name = "Evidence for Task 2") +
  scale_x_continuous(name = "Evidence for Task 1") +
  facet_grid(type_data ~ Correlation, labeller = "label_both") +
  theme_classic() +
  theme(legend.position = "bottom",
        strip.background = element_blank()) 
```


```{r}
se <- function(x) {
  out <- sqrt(var(x)/length(x))
  return(out)
}

d %>%
  rename(Correlation = condition_rho) %>%
  mutate(condition = factor(condition)) %>%
  group_by(condition, Correlation, type_data) %>%
  summarise(y1_se = se(y1), y1 = mean(y1), n = n(), 
            y2_se = se(y2), y2 = mean(y2)) %>%
  ggplot(aes(x = y1, y = y2, fill = condition, color = condition)) +
  geom_point() +
  geom_errorbar(aes(y = y2, ymin = y2 - y2_se, ymax = y2 + y2_se)) +
  geom_errorbarh(aes(x = y1, xmin = y1 - y1_se, xmax = y1 + y1_se)) +
  coord_cartesian() +
  coord_fixed() +
  scale_y_continuous(name = "Evidence for Task 2") +
  scale_x_continuous(name = "Evidence for Task 1") +
  facet_grid(type_data ~ Correlation, labeller = "label_both") +
  # theme_classic() +
  theme(legend.position = "bottom",
        strip.background = element_blank()) 
```

```{r stan_data}

# parameters that will be excluded from model
pars <- c("theta_log", "theta_raw", "lps",
         "Mu_unordered", "Mu_ordered",
         "subject_mu_raw", "item_mu_raw", "subject_mu", "item_mu",
         "subject_L", "item_L",
         "condition_omega")

d_fit <- d %>% 
  crossing(type_model = params$type_model) %>%
  group_by(expt, type_model, rep, type_data) %>%
  nest() %>%
  mutate(data = map2(data, type_model, ~.x %>% mutate(type = .y))) %>%
  mutate(stan_data = map(data, ~gen_stan_data(.x)))

```


```{r fit}
  
post <- vector(mode = "list", length = nrow(d_fit))

for(m in 1:6){
  model <- stan_model(file.path(devtools::package_file(), "stan", paste0(params$model, ".stan")))
  post[[m]] <- sampling(model, 
                        data = d_fit$stan_data[[m]], 
                        iter = params$warmup + params$iter,
                        warmup = params$warmup,
                        chains = params$chains
                        , pars = pars
                        , include = FALSE
                        , init_r = 0.5
  )
  
  d_post <- d_fit %>%
    mutate(post = post)
  
  readr::write_rds(x=d_post, path = file.path(devtools::package_file(), "output", "stan_samples", params$model, params$flag, glue::glue("data_post-{m}.rds")))
  
  loaded_dlls = getLoadedDLLs()
  if(str_detect(loaded_dlls, model@dso@dso_filename) ){
    message("Unloading DLL for model dso ", model@dso@dso_filename)
    model.dll = loaded_dlls[[model@dso@dso_filename]][['path']]
    dyn.unload(model.dll)
  } else {
    message("No loaded DLL for model dso ", model@dso@dso_filename)
  }
  rm(model)
}


readr::write_rds(x=d_post, path = file.path(devtools::package_file(), "output", "stan_samples", params$model, params$flag, "data_post.rds"))

```


```{r}

post <- d_post %>%
  mutate(log_lik = map(post, ~loo::extract_log_lik(.x))) %>%
  mutate(waic = map(log_lik, ~loo::waic(.x))) %>%
  mutate(loo = map(log_lik, ~ loo::loo(.x))) %>%
  mutate(type_data = map_chr(data, ~ extract2(.x$type_data,1)),
         type = map_chr(data, ~ extract2(.x$type,1)),
         rep = map_int(data, ~ extract2(.x$rep)))


# loo::compare(extract2(post$waic,1),extract2(post$waic,2))
```


```{r}

post <- tidybayes::gather_samples(estimated_model_mon,
                                  condition_mu_ordered[order,question,condition]) %>%
  ungroup()
theta <- tidybayes::gather_samples(estimated_model_mon,
                                   theta[order]) %>%
  ungroup() %>%
  mutate(order = factor(order))

post %>%
  mutate(condition = factor(condition)) %>%
  ggplot(aes(x=condition, y = estimate)) +
  geom_violin() +
  facet_grid(order~question, labeller = "label_both")

theta %>%
  ggplot(aes(x=order, y=estimate)) +
  geom_violin() 
```


```{r}
library(loo)
tmp_mon <- extract_log_lik(estimated_model_mon)
tmp_Nmon <- extract_log_lik(estimated_model_Nmon)
mon_waic <- loo::waic(tmp_mon)
nmon_waic <- loo::waic(tmp_Nmon)
loo::compare(mon_waic, nmon_waic)
```


