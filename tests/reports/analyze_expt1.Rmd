---
title: 'Model Recovery: Bivariate Probit'
author: "pss"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data_dir: data
  expt: CFSgonogo
  model: "bivariate_probit_mixed_onec_mo_nonc"
  flag: "expt1"
  type: !r c("mon", "nmon")
  cutoff: 1
  chains: 6
  iter: 1000
  warmup: 1000
  compile: 0
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, root.dir = devtools::package_file(), message = FALSE, warning = FALSE, fig.width = 7, fig.asp = 1, cache = FALSE, cache.path = paste0(file.path(devtools::package_file(), "output", "cache", params$model, params$flag, params$participant), .Platform$file.sep), fig.path = paste0(file.path(devtools::package_file(), "output", "figures", params$model, params$flag), .Platform$file.sep) )

devtools::load_all()

dir.model <- file.path(dir.stan_samples, params$model)
if (!dir.exists(dir.model)){
  dir.create(dir.model)
}
dir.model_flag <- file.path(dir.model, params$flag)
if (!dir.exists(dir.model_flag)){
  dir.create(dir.model_flag)
}

options(mc.cores = params$chains)
rstan::rstan_options("auto_write" = TRUE)

if (params$compile){
  rstan::stan_model(file.path(devtools::package_file(), "stan", paste0(params$model, ".stan")))
}

targets <- readr::read_csv(file.path(devtools::package_file(), 'data', 'objectNames.csv'), col_names = FALSE)


d <- readr::read_csv(file.path(devtools::package_file(), 'data', 'data.csv')) %>%
  mutate(targets = map(object, ~targets[.x,])) %>%
  mutate(firstTarget = map_chr(targets, ~extract2(.x,1))) %>%
  mutate(dl = map2(targets, responses, ~stringdist::stringdist(purrr::as_vector(.x), .y, method="dl"))) %>%
  mutate(minDist = map_dbl(dl, ~min(.x, na.rm=TRUE))) %>%
  mutate(y2 = if_else(minDist < params$cutoff, 1L, 0L)) %>%
  rename(y1 = afc,
         item = object) %>%
  select(-pas, -pas2,-objectPair,-responses,-targets,-dl, -minDist, -firstTarget,-list) %>%
  tidyr::crossing(., type = params$type) %>%
  mutate(expt = if_else(type=="mon",1,2)) 


```


```{r stan_data}

# parameters that will be excluded from model
pars <- c("theta_log", "theta_raw", "lps",
         "Mu_unordered", "Mu_ordered",
         "subject_mu_raw", "item_mu_raw", "subject_mu", "item_mu",
         "subject_L", "item_L",
         "condition_omega")

d_fit <- d %>% group_by(expt) %>%
  nest() %>%
  mutate(stan_data = map(data, ~gen_stan_data(.x)))

```


```{r fit}
  
d_post <- d_fit %>%
  mutate(post = map(stan_data, ~  sampling(readr::read_rds(file.path(devtools::package_file(), "stan", paste0(params$model, ".rds"))), 
                                           data = .x, 
                                           iter = params$warmup + params$iter,
                                           warmup = params$warmup,
                                           chains = params$chains
                                           , pars = pars
                                           , include = FALSE
                                           , init_r = 0.5
  )))


readr::write_rds(x=d_post, path = file.path(devtools::package_file(), "output", "stan_samples", params$model, params$flag, "data_post.rds"))

```


```{r}

post <- d_post %>%
  mutate(log_lik = map(post, ~loo::extract_log_lik(.x))) %>%
  mutate(waic = map(log_lik, ~loo::waic(.x))) %>%
  mutate(loo = map(log_lik, ~ loo::loo(.x)))


loo::compare(extract2(post$waic,1),extract2(post$waic,2))
```

```{r}
post_nmon <- readr::read_rds(path = file.path(devtools::package_file(), "output", "stan_samples", params$model, 'dev', "data_post.rds"))

post_nmon <- post_nmon %>%
  mutate(log_lik = map(post, ~loo::extract_log_lik(.x))) %>%
  mutate(waic = map(log_lik, ~loo::waic(.x))) %>%
  mutate(loo = map(log_lik, ~ loo::loo(.x)))

loo::compare(extract2(post_nmon$waic,1),extract2(post_nmon$waic,2))
```


```{r}

post <- tidybayes::gather_samples(estimated_model_mon,
                                  condition_mu_ordered[order,question,condition]) %>%
  ungroup()
theta <- tidybayes::gather_samples(estimated_model_mon,
                                   theta[order]) %>%
  ungroup() %>%
  mutate(order = factor(order))

post %>%
  mutate(condition = factor(condition)) %>%
  ggplot(aes(x=condition, y = estimate)) +
  geom_violin() +
  facet_grid(order~question, labeller = "label_both")

theta %>%
  ggplot(aes(x=order, y=estimate)) +
  geom_violin() 
```


```{r}
library(loo)
tmp_mon <- extract_log_lik(estimated_model_mon)
tmp_Nmon <- extract_log_lik(estimated_model_Nmon)
mon_waic <- loo::waic(tmp_mon)
nmon_waic <- loo::waic(tmp_Nmon)
loo::compare(mon_waic, nmon_waic)
```


