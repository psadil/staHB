---
title: "Main"
author: "pss"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
params:
  data_dir: data
  expt: CFSgonogo
  model: "brms"
  flag: "dev"
  n_groups: 6
  n_trials_per_cond: 500
  chains: 2
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, root.dir = devtools::package_file(), message = FALSE, warning = FALSE, fig.width = 7, fig.asp = 1, cache = FALSE, cache.path = paste0(file.path(devtools::package_file(), "output", "cache", params$model, params$flag, params$participant), .Platform$file.sep), fig.path = paste0(file.path(devtools::package_file(), "output", "figures", params$model, params$flag), .Platform$file.sep) )

library(tidyverse)
library(magrittr)
library(modelr)
library(brms)
options(mc.cores = params$chains)

cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

Conditions = c('Not Studied', "Word", 'CFS, Image', 'Binocular, Image')

colmap <- c('Not Studied'=cbPalette[7]
            ,'Word'=cbPalette[2]
            ,'CFS, Image'=cbPalette[3]
            ,'Binocular, Image'=cbPalette[4])

old_theme <- theme_set(theme_classic(base_size = 12)) +
  theme_update(
    axis.ticks = element_blank()
    , axis.line = element_line(size=1)
    , plot.margin=margin(rep(0,4))
  )

```


```{r create_data}
mu_x <- c(-2,-1,1,2)
mu_y <- c(-2,1,-1,2)
d_Nmon <- crossing(factor_x = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              factor_y = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              trial = 1:params$n_trials_per_cond) %>%
  mutate(x_y = map2(factor_x, factor_y, ~ cbind(mu_x[.x],mu_y[.y]) + mvtnorm::rmvnorm(1, mean = rep(0,2)))) %>%
  mutate(evidence_x = map_dbl(x_y, ~purrr::pluck(.x, 1)),
         evidence_y = map_dbl(x_y, ~purrr::pluck(.x, 2))
         ) %>%
  select(-x_y) %>%
  filter(factor_x == factor_y) %>%
  mutate(Condition = factor_x)


d_mon <- crossing(factor_x = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              factor_y = factor(1:4, levels = c(1,2,3,4), ordered = TRUE),
              trial = 1:params$n_trials_per_cond) %>%
  mutate(x_y = map2(factor_x, factor_y, ~ cbind(mu_x[.x],mu_x[.y]) + mvtnorm::rmvnorm(1, mean = rep(0,2)))) %>%
  mutate(evidence_x = map_dbl(x_y, ~purrr::pluck(.x, 1)),
         evidence_y = map_dbl(x_y, ~purrr::pluck(.x, 2))
         ) %>%
  select(-x_y) %>%
  filter(factor_x == factor_y) %>%
  mutate(Condition = factor_x)
  

```

```{r, plot_data}

d_Nmon %>%
  ggplot(aes(x = evidence_x, y = evidence_y, fill = Condition)) +
  stat_ellipse(type = "norm", geom = "polygon") +
  coord_cartesian()

d_mon %>%
  ggplot(aes(x = evidence_x, y = evidence_y, fill = Condition)) +
  stat_ellipse(type = "norm", geom = "polygon") +
  coord_cartesian()

```



```{r}

form <- brms::bf(cbind(evidence_x, evidence_y) ~ mo(Condition))

mon_to_Nmon <- brms::brm(form,
                         data = d_Nmon,
                         chains = params$chains)

Nmon_to_Nmon <- update(mon_to_Nmon, 
                       formula. = ~ . -mo(Condition) + Condition, 
                       newdata = d_Nmon)

mon_to_mon <- update(mon_to_mon, newdata = d_mon)
Nmon_to_mon <- update(Nmon_to_mon, newdata = d_mon)


```


```{r waic1}
brms::WAIC(Nmon_to_Nmon, mon_to_Nmon)
```


```{r, waic2}
brms::WAIC(nmon_to_mon, mon_to_mon)
```


